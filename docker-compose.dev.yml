# docker-compose.dev.yml
services:
  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE:      ${DB_NAME}
    ports:
      - "3306:3306"
    volumes:
      - db-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-p${DB_PASSWORD}"]
      interval: 5s
      retries: 5

  # ---- MailHog (SMTP de dev) ----
  mailhog:
    image: mailhog/mailhog:latest
    ports:
      - "1025:1025"   # SMTP
      - "8025:8025"   # UI Web http://localhost:8025
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8025"]
      interval: 5s
      timeout: 3s
      retries: 5

  backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    volumes:
      - ./src:/app/src
      - ./pom.xml:/app/pom.xml
      - promo-images:/var/www/promo
      - ./uploads:/var/www/promo
      - m2-repo:/root/.m2/repository
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: dev

      # ---- DB (dev) ----
      DB_HOST: db
      DB_PORT: 3306
      DB_NAME: jlh_autopam
      DB_USERNAME: root
      DB_PASSWORD: password

      # ---- SMTP (MailHog) ----
      MAIL_HOST: mailhog
      MAIL_PORT: 1025
      # Si tu utilises Mailtrap à la place, commente ces deux lignes
      # et exporte MAIL_HOST/MAIL_PORT/MAIL_USERNAME/MAIL_PASSWORD dans ton shell.

      # Optionnel si tu as un 'from' externalisé (sinon pris du application.yml)
      # MAIL_USERNAME:
      # MAIL_PASSWORD:
    depends_on:
      db:
        condition: service_healthy
      mailhog:
        condition: service_healthy

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./uploads:/var/www/promo:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      - backend

volumes:
  db-data:
  promo-images:
  m2-repo:
