# docker-compose.dev.yml
services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-password}
      POSTGRES_DB: ${DB_NAME:-jlh_autopam}
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME} -d ${DB_NAME}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  # ---- MailHog (SMTP de dev) ----
  mailhog:
    image: mailhog/mailhog:latest
    ports:
      - "1025:1025"   # SMTP
      - "8025:8025"   # UI Web http://localhost:8025
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8025"]
      interval: 5s
      timeout: 3s
      retries: 5

  backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    volumes:
      - ./src:/app/src
      - ./pom.xml:/app/pom.xml
      - promo-images:/var/www/promo
      - ./uploads:/var/www/promo
      - m2-repo:/root/.m2/repository
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: dev

      # ---- DB (dev) ----
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-jlh_autopam}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-password}
      DB_URL: jdbc:postgresql://db:5432/${DB_NAME:-jlh_autopam}?sslmode=disable

      # ---- SMTP (MailHog) ----
      MAIL_HOST: mailhog
      MAIL_PORT: 1025
      # Si tu utilises Mailtrap à la place, commente ces deux lignes
      # et exporte MAIL_HOST/MAIL_PORT/MAIL_USERNAME/MAIL_PASSWORD dans ton shell.

      # Optionnel si tu as un 'from' externalisé (sinon pris du application.yml)
      # MAIL_USERNAME:
      # MAIL_PASSWORD:
    depends_on:
      db:
        condition: service_healthy
      mailhog:
        condition: service_healthy

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./uploads:/var/www/promo:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      - backend

volumes:
  postgres-data:
  promo-images:
  m2-repo:
