# JLH AutoPam Backend – Guide technique

## 1. Vue d'ensemble
JLH AutoPam est une API REST Spring Boot 3.5 construite sur Java 17 pour piloter l'activité d'un garage automobile : gestion des clients, demandes de services, rendez-vous, promotions et documents associés. Le projet s'appuie sur les starters Web, Data JPA, Security, Validation, Actuator et Mail, complétés par MapStruct, Lombok, JWT (jjwt) et une base MySQL en production, avec H2, Mockito et Spring Security Test pour la couverture automatisée.【F:pom.xml†L11-L134】 L'application principale active la planification et le binding typé des propriétés du garage afin d'alimenter les ICS et notifications planifiées.【F:src/main/java/com/jlh/jlhautopambackend/JlhApplication.java†L9-L20】【F:src/main/java/com/jlh/jlhautopambackend/config/GarageProperties.java†L6-L13】

## 2. Build et conteneurisation
- **Maven** : la configuration Maven renseigne l'encodage, Java 17, le plugin compiler avec les processors Lombok/MapStruct et le plugin Spring Boot pour empaqueter le JAR exécutable `app.jar`.【F:pom.xml†L137-L198】
- **Docker** : l'image multi-étapes compile l'app dans un conteneur Maven avant de l'exécuter sur une JVM légère (profil `prod`) avec un healthcheck HTTP vers Actuator.【F:Dockerfile†L1-L30】
- **Compose développement** : `docker-compose.dev.yml` assemble MySQL 8, MailHog, le backend en profil `dev`, un volume partagé `/var/www/promo` pour les images et un Nginx frontal qui sert les fichiers statiques générés par l'API.【F:docker-compose.dev.yml†L1-L80】
- **Compose production** : `docker-compose.prod.yml` orchestre MySQL, l'image du backend, et Nginx en partageant le même volume `promo-images` pour exposer les médias des promotions côté HTTP.【F:docker-compose.prod.yml†L1-L57】

## 3. Configuration et profils
- **Configuration générique (`application.yml`)** : contient l'identité du garage, les URLs back/front, les paramètres d'envoi d'e-mails, le répertoire d'upload `/var/www/promo`, les limites multipart et la configuration JWT (clé et durée).【F:src/main/resources/application.yml†L1-L26】
- **Profil développement (`application-dev.properties`)** : configure la connexion MySQL via variables d'environnement, force le dialecte MySQL 8, charge `schema_jlh_autopam.sql` et `data.sql`, expose l'URL publique des images et câble MailHog.【F:src/main/resources/application-dev.properties†L1-L35】
- **Profil production (`application-prod.properties`)** : attend les secrets JDBC externes, bascule JPA en `update`, conserve le même dossier d'upload et référence le SMTP Hostinger pour les notifications.【F:src/main/resources/application-prod.properties†L1-L21】
- **Propriétés spécialisées** : `GarageProperties` lie `garage.name`, `address`, `organizerEmail` et `timezone`, exploités pour enrichir les ICS et communications.【F:src/main/java/com/jlh/jlhautopambackend/config/GarageProperties.java†L6-L13】

## 4. Architecture du code
- **Configuration sécurité** : `SecurityConfig` définit une API JWT stateless, sépare les routes publiques/clients/admin, expose des réponses JSON 401/403 et installe la configuration CORS pour le front Angular, tandis que `JwtAuthenticationFilter` injecte l'authentification dans le `SecurityContext`.【F:src/main/java/com/jlh/jlhautopambackend/config/SecurityConfig.java†L39-L135】【F:src/main/java/com/jlh/jlhautopambackend/config/JwtAuthenticationFilter.java†L19-L54】
- **Contrôleurs REST** : `AuthController` gère login JWT, inscription avec envoi du mail de vérification et réinitialisation de mot de passe ; `MeController` expose la consultation et la mise à jour du profil client ainsi que le changement de mot de passe ; `PromotionController` fournit des endpoints multipart pour créer/mettre à jour les promotions, et `HealthController` répond sur `/healthz` pour les probes externes.【F:src/main/java/com/jlh/jlhautopambackend/controllers/AuthController.java†L27-L146】【F:src/main/java/com/jlh/jlhautopambackend/controllers/MeController.java†L18-L111】【F:src/main/java/com/jlh/jlhautopambackend/controllers/PromotionController.java†L17-L147】【F:src/main/java/com/jlh/jlhautopambackend/controllers/HealthController.java†L6-L11】
- **DTO et validation** : le package `dto` sépare clairement les charges utiles (ex. `ClientMeDto`, `PromotionRequest`) avec annotations Jakarta Validation pour sécuriser les entrées des contrôleurs.【F:src/main/java/com/jlh/jlhautopambackend/dto/ClientMeDto.java†L7-L24】【F:src/main/java/com/jlh/jlhautopambackend/dto/PromotionRequest.java†L1-L78】
- **Mappers MapStruct** : `PromotionMapper` reconstruit les entités/DTO en appliquant l'URL d'image absolue via `app.images.base-url`, évitant la logique répétitive côté contrôleurs.【F:src/main/java/com/jlh/jlhautopambackend/mapper/PromotionMapper.java†L10-L70】
- **Entités et référentiel** : les entités JPA du package `modeles` (ex. `Promotion`) modélisent clients, demandes, rendez-vous, promotions et timeline ; les interfaces `repository` héritent de `JpaRepository` et exposent des requêtes spécifiques comme la purge des promotions expirées.【F:src/main/java/com/jlh/jlhautopambackend/modeles/Promotion.java†L8-L32】【F:src/main/java/com/jlh/jlhautopambackend/repository/PromotionRepository.java†L9-L12】
- **Services métiers** :
  - `PromotionServiceImpl` orchestre les validations métier, le stockage/suppression d'images et la liaison administrateur pour les promotions (avec surcharges test-friendly).【F:src/main/java/com/jlh/jlhautopambackend/services/PromotionServiceImpl.java†L23-L176】
  - `FileSystemStorageService` stocke les fichiers sur disque avec nettoyage du nom et suppression sécurisée ; `PromotionCleanupService` supprime chaque nuit les promotions expirées et leurs fichiers associés pour garder le volume propre.【F:src/main/java/com/jlh/jlhautopambackend/services/FileSystemStorageService.java†L15-L43】【F:src/main/java/com/jlh/jlhautopambackend/services/PromotionCleanupService.java†L22-L103】
  - `AuthenticatedClientResolver` centralise la résolution du client courant depuis le token pour les contrôleurs côté client.【F:src/main/java/com/jlh/jlhautopambackend/services/support/AuthenticatedClientResolver.java†L12-L29】
- **Utilitaires** : `JwtUtil` gère la génération/validation de tokens signés HS256, et `IcsUtil` produit des fichiers ICS avec alarmes -24h/-1h et métadonnées organisateur, réutilisés par les services de rendez-vous.【F:src/main/java/com/jlh/jlhautopambackend/utils/JwtUtil.java†L17-L87】【F:src/main/java/com/jlh/jlhautopambackend/utils/IcsUtil.java†L9-L106】
- **Gestion centralisée des erreurs** : `RestExceptionHandler` fournit des réponses JSON cohérentes pour les erreurs de validation, les conflits et les exceptions inattendues afin de simplifier la consommation front-end.【F:src/main/java/com/jlh/jlhautopambackend/web/RestExceptionHandler.java†L19-L88】
- **Tests** : les tests Web MVC (ex. `PromotionControllerTest`) valident les endpoints REST, tandis que d'autres classes de tests couvrent services, DTOs et mappers via un profil H2 en mémoire.【F:src/test/java/com/jlh/jlhautopambackend/controllers/PromotionControllerTest.java†L1-L200】【F:src/main/resources/application-test.properties†L1-L11】

## 5. Données, scripts et démarrage
- **Schéma de référence** : `schema_jlh_autopam.sql` définit l'intégralité du modèle relationnel (clients, demandes, services, devis, promotions, créneaux, timeline) en cohérence avec les entités JPA.【F:src/main/resources/schema_jlh_autopam.sql†L1-L181】
- **Jeu de données** : `data.sql` ajoute des lookups, des comptes de test, des créneaux et des demandes pré-remplies, tout en évoluant le schéma MySQL (colonnes email_verified, username) pour faciliter les tests manuels et front-end.【F:src/main/resources/data.sql†L1-L158】
- **Probing** : outre `/actuator/health`, l'endpoint `/healthz` répond `OK`, utile pour les load balancers externes.【F:src/main/java/com/jlh/jlhautopambackend/controllers/HealthController.java†L6-L11】

Ce document sert de porte d'entrée technique pour les nouveaux développeurs ou intégrateurs, en complément de `docs/DOCKER.md` qui couvre les procédures de build et de déploiement conteneurisé.【F:docs/DOCKER.md†L1-L179】
