# JLH AutoPam Backend – Guide technique

## 1. Stack et point d'entrée
- **Pile technique** : Spring Boot 3.5 tourne sur Java 17 avec les starters Web, Data JPA, Security, Validation, Actuator et Mail, complétés par MapStruct, Lombok, jjwt et PostgreSQL/H2 côté base de données et Mockito/Spring Security Test pour la couverture automatisée.【F:pom.xml†L8-L135】
- **Application principale** : `JlhApplication` active la planification Spring et lie les `GarageProperties` (nom, adresse, fuseau, e-mail organisateur) pour alimenter les ICS et communications sortantes.【F:src/main/java/com/jlh/jlhautopambackend/JlhApplication.java†L1-L20】【F:src/main/java/com/jlh/jlhautopambackend/config/GarageProperties.java†L1-L13】

## 2. Build, exécution et conteneurs
- **Build Maven** : le `pom` fixe l'encodage, configure MapStruct/Lombok comme annotation processors, empaquette le JAR via `spring-boot-maven-plugin` et active Surefire pour les tests unitaires.【F:pom.xml†L137-L205】
- **Dockerfile** : image multi-étapes (`maven:3.9.2-temurin-17` ➜ `eclipse-temurin:17-jre`) qui compile l'app (`mvn clean package -DskipTests`) puis exécute `app.jar` avec un healthcheck HTTP et le profil Spring `prod` par défaut.【F:Dockerfile†L1-L30】
- **Compose développement** : `docker-compose.dev.yml` monte PostgreSQL 16, MailHog, le backend (profil `dev`) avec montages `./src`, `./pom.xml`, volume `promo-images` partagé avec un répertoire `./uploads` exposé via Nginx, et un cache Maven (`m2-repo`). Les services sont reliés par variables d'env (`DB_*`, `MAIL_*`) et healthchecks.【F:docker-compose.dev.yml†L1-L81】
- **Compose production** : `docker-compose.prod.yml` déploie PostgreSQL 16, l'image `steve57/jlh-autopam-backend:latest` en profil `prod` et Nginx. Les volumes `db-data`/`promo-images` et le réseau `backend` sont partagés afin d'exposer les images de promotion sur le frontal HTTP.【F:docker-compose.prod.yml†L1-L68】

## 3. Configuration applicative
- **Configuration commune** : `application.yml` fixe les méta-données du garage, les URLs back/front, l'adresse e-mail d'envoi, le répertoire d'upload `/var/www/promo`, les limites multipart et les paramètres JWT (clé BASE64 + durée).【F:src/main/resources/application.yml†L1-L26】
- **Profil `dev`** : connexion PostgreSQL paramétrable via `DB_HOST/PORT/NAME/USERNAME/PASSWORD`, dialecte PostgreSQL, initialisation `schema_jlh_autopam.sql` + `data.sql`, répertoire d'upload synchronisé avec le volume Docker et base URL des images pointant sur Nginx (`http://localhost:80/promotions/images/`).【F:src/main/resources/application-dev.properties†L1-L35】
- **Profil `prod`** : attend `DB_URL/USERNAME/PASSWORD`, garde `app.upload-dir` synchronisé avec `/var/www/promo`, publie les images via `https://api.jlh-auto.fr/promotions/images/` et configure Hostinger comme SMTP.【F:src/main/resources/application-prod.properties†L1-L21】
- **Profil `test`** : active un H2 en mémoire, Hibernate `update` et un SMTP factice, ce qui permet d'exécuter les tests sans dépendances externes.【F:src/main/resources/application-test.properties†L1-L18】

## 4. Surface HTTP et sécurité
- **Sécurité** : `SecurityConfig` impose une API stateless JWT avec autorisations fines (routes publiques Auth/Promotions/Services, rôles CLIENT vs ADMIN, endpoints ICS dédiés) et configure CORS pour le front Angular ; `JwtAuthenticationFilter` valide chaque token avant d'enrichir le `SecurityContext`.【F:src/main/java/com/jlh/jlhautopambackend/config/SecurityConfig.java†L1-L135】【F:src/main/java/com/jlh/jlhautopambackend/config/JwtAuthenticationFilter.java†L1-L54】
- **Contrôleurs d'authentification/profil** : `AuthController` orchestre login JWT, inscription avec e-mail de vérification, renvoi de lien, vérification et réinitialisation de mot de passe ; `MeController` autorise la consultation/mise à jour partielle du profil ainsi que le changement de mot de passe authentifié.【F:src/main/java/com/jlh/jlhautopambackend/controllers/AuthController.java†L1-L125】【F:src/main/java/com/jlh/jlhautopambackend/controllers/MeController.java†L1-L117】
- **Administration clients et promotions** : `ClientController` expose le CRUD complet en s'appuyant sur `ClientService`, tandis que `PromotionController` gère les endpoints multipart pour créer/mettre à jour les promotions et supprimer les visuels obsolètes.【F:src/main/java/com/jlh/jlhautopambackend/controllers/ClientController.java†L1-L59】【F:src/main/java/com/jlh/jlhautopambackend/controllers/PromotionController.java†L1-L72】
- **Flux demandes/rendez-vous** : `DemandeController` et `RendezVousController` segmentent les actions ADMIN (listing, suppression, ICS complet) et CLIENT (création, stats, ICS filtrés, soumission) tout en résolvant le client courant via `AuthenticatedClientResolver`. Les endpoints ICS produisent des fichiers `text/calendar` prêts à être importés.【F:src/main/java/com/jlh/jlhautopambackend/controllers/DemandeController.java†L1-L188】【F:src/main/java/com/jlh/jlhautopambackend/controllers/RendezVousController.java†L1-L71】
- **Autres surfaces REST** : des contrôleurs dédiés existent pour les documents de demande, les timelines, les statuts, les administrateurs et les disponibilités afin de couvrir l'intégralité du domaine garage (voir `src/main/java/com/jlh/jlhautopambackend/controllers`).
- **Gestion centralisée des erreurs** : `RestExceptionHandler` et `ValidationAdvice` unifient les réponses JSON pour les validations, erreurs de type, conflits ou exceptions inattendues, ce qui simplifie la consommation front-end.【F:src/main/java/com/jlh/jlhautopambackend/web/RestExceptionHandler.java†L1-L88】【F:src/main/java/com/jlh/jlhautopambackend/advice/ValidationAdvice.java†L1-L28】

## 5. Services métier et infrastructure
- **Clients** : `ClientServiceImpl` encode les mots de passe, persiste les coordonnées, relance automatiquement l'e-mail de vérification lors d'une création/mise à jour et expose `ClientResponse` via MapStruct ; `EmailVerificationService` gère la vie des tokens et l'envoi d'e-mails HTML ; `PasswordResetServiceImpl` produit des liens temporisés et applique les nouveaux mots de passe côté `Client`.【F:src/main/java/com/jlh/jlhautopambackend/services/ClientServiceImpl.java†L1-L100】【F:src/main/java/com/jlh/jlhautopambackend/services/EmailVerificationService.java†L1-L72】【F:src/main/java/com/jlh/jlhautopambackend/services/PasswordResetServiceImpl.java†L1-L85】
- **Demandes & timeline** : `DemandeServiceImpl` associe clients, types et statuts en validant l'existence de chaque identifiant puis journalise les changements via `DemandeTimelineService`. Plusieurs méthodes avancées (stats clients, prochain RDV, ICS, demandes courantes) restent à implémenter et retournent actuellement `null` ou `Optional.empty()`, ce qui doit être pris en compte avant mise en production.【F:src/main/java/com/jlh/jlhautopambackend/services/DemandeServiceImpl.java†L1-L158】
- **Timeline** : `DemandeTimelineServiceImpl` fusionne évènements statut/commentaire/montant/documents/rdv, filtre la visibilité client, et persiste chaque entrée via `DemandeTimelineRepository` et `DemandeTimelineMapper`.【F:src/main/java/com/jlh/jlhautopambackend/services/DemandeTimelineServiceImpl.java†L1-L200】
- **Promotions & stockage** : `PromotionServiceImpl` pilote les validations, l'association administrateur, l'upload/suppression d'images, et publie les URLs absolues via `PromotionMapper` alimenté par `app.images.base-url`. Le stockage disque est factorisé dans `FileSystemStorageService` et la suppression quotidienne des promotions expirées + fichiers associés est assurée par `PromotionCleanupService` (cron 23h59).【F:src/main/java/com/jlh/jlhautopambackend/services/PromotionServiceImpl.java†L1-L167】【F:src/main/java/com/jlh/jlhautopambackend/mapper/PromotionMapper.java†L1-L70】【F:src/main/java/com/jlh/jlhautopambackend/services/FileSystemStorageService.java†L1-L44】【F:src/main/java/com/jlh/jlhautopambackend/services/PromotionCleanupService.java†L1-L103】
- **Utilitaires transverses** : `AuthenticatedClientResolver` centralise la résolution du client depuis le `SecurityContext`, `JwtUtil` gère la génération/validation HS256 et `IcsUtil` construit des calendriers ICS avec double alarme (-24h/-1h).【F:src/main/java/com/jlh/jlhautopambackend/services/support/AuthenticatedClientResolver.java†L1-L30】【F:src/main/java/com/jlh/jlhautopambackend/utils/JwtUtil.java†L1-L87】【F:src/main/java/com/jlh/jlhautopambackend/utils/IcsUtil.java†L1-L106】
- **Mail & stockage** : `MailService` envoie les messages HTML via `JavaMailSender`, tandis que `FileSystemStorageService` encapsule la création du dossier d'upload et la suppression sécurisée des fichiers (utilisé par les promotions et les documents).【F:src/main/java/com/jlh/jlhautopambackend/services/MailService.java†L1-L29】【F:src/main/java/com/jlh/jlhautopambackend/services/FileSystemStorageService.java†L1-L44】

## 6. Données de référence et tests
- **Schéma et données** : `schema_jlh_autopam.sql` décrit l'ensemble des tables (clients, demandes, services, créneaux, statuts, documents, devis) et `data.sql` ajoute les données de référence tout en évoluant le schéma (colonnes de vérification e-mail, véhicules, username administrateur) et en insérant un catalogue complet de services/statuts/utilisateurs de test.【F:src/main/resources/schema_jlh_autopam.sql†L1-L86】【F:src/main/resources/data.sql†L1-L86】
- **Tests automatisés** : les tests Web MVC comme `PromotionControllerTest` vérifient la sérialisation JSON et les endpoints multipart, tandis que d'autres classes de test couvrent services/mappers en s'appuyant sur le profil `test` H2.【F:src/test/java/com/jlh/jlhautopambackend/controllers/PromotionControllerTest.java†L1-L118】【F:src/main/resources/application-test.properties†L1-L18】

## 7. À surveiller avant mise en production
Certaines fonctionnalités exposées dans les contrôleurs (statistiques clients, prochain rendez-vous, ICS spécifiques) reposent encore sur des méthodes de service non implémentées (`Optional.empty()`/`null` dans `DemandeServiceImpl`). Il est recommandé de compléter ces méthodes ou de restreindre temporairement les endpoints concernés afin d'éviter des réponses 204/500 inattendues.【F:src/main/java/com/jlh/jlhautopambackend/services/DemandeServiceImpl.java†L47-L157】
