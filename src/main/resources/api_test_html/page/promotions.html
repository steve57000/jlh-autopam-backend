<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Test Promotions API</title>
    <script src="../js/init.js"></script>
    <link rel="stylesheet" href="../css/common.css" />
    <style>
        .api-doc table { border-collapse: collapse; width: 100%; margin-bottom: 1em; }
        .api-doc th, .api-doc td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
        .api-doc th { background: #f5f5f5; }
        .api-doc code { background: #eee; padding: 2px 4px; border-radius: 4px; }
        section { margin-bottom: 2em; }
        pre { background: #fafafa; padding: 1em; border: 1px solid #ddd; overflow-x: auto; }
        textarea { width: 100%; height: 6em; }
        input[type="text"] { width: 4em; }
    </style>
</head>
<body>
<div id="nav-placeholder"></div>
<h1>Test Promotions API</h1>

<section class="api-doc">
    <h2>Documentation de l’API</h2>
    <table>
        <thead>
        <tr><th>Méthode</th><th>Endpoint</th><th>Description</th></tr>
        </thead>
        <tbody>
        <tr><td>GET</td><td><code>/api/promotions</code></td><td>Récupère toutes les promotions.</td></tr>
        <tr><td>GET</td><td><code>/api/promotions/{id}</code></td><td>Récupère une promotion par son ID.</td></tr>
        <tr><td>POST</td><td><code>/api/promotions</code></td><td>Crée une nouvelle promotion.</td></tr>
        <tr><td>PUT</td><td><code>/api/promotions/{id}</code></td><td>Met à jour une promotion existante.</td></tr>
        <tr><td>DELETE</td><td><code>/api/promotions/{id}</code></td><td>Supprime une promotion.</td></tr>
        </tbody>
    </table>
    <h3>Modèle JSON (request / response)</h3>
    <pre>{
  "idPromotion": 1,
  "administrateurId": 1,
  "imageUrl": "https://example.com/promo.jpg",
  "validFrom": "2025-06-01T00:00:00Z",
  "validTo":   "2025-06-07T23:59:59Z",
  "description": "Texte décrivant la promotion"
}</pre>
</section>

<!-- GET ALL -->
<section>
    <h2>GET /api/promotions</h2>
    <button onclick="fetchGetAll()">GET All</button>
    <pre id="getAllOutput"></pre>
</section>

<!-- GET BY ID -->
<section>
    <h2>GET /api/promotions/{id}</h2>
    ID: <input type="text" id="getId" value="1" />
    <button onclick="fetchGetById()">GET by ID</button>
    <pre id="getByIdOutput"></pre>
</section>

<!-- POST -->
<section>
    <h2>POST /api/promotions</h2>
    <label for="postDesc">Description :</label><br/>
    <textarea id="postDesc">Nouvelle super promo !</textarea><br/>

    <label for="fileInput">Image (fichier) :</label>
    <input type="file" id="fileInput"/><br/><br/>

    <button onclick="fetchPost()">POST</button>
    <pre id="postOutput"></pre>
</section>

<!-- PUT -->
<section>
    <h2>PUT /api/promotions/{id}</h2>
    ID : <input type="text" id="putId" value="1" /><br/><br/>

    <label for="putDesc">Description :</label><br/>
    <textarea id="putDesc">Description mise à jour</textarea><br/>

    Fichier image (optionnel) : <input type="file" id="putFile"/><br/><br/>

    <button onclick="fetchPut()">PUT</button>
    <pre id="putOutput"></pre>
</section>

<!-- DELETE -->
<section>
    <h2>DELETE /api/promotions/{id}</h2>
    ID : <input type="text" id="deleteId" value="1" />
    <button onclick="fetchDelete()">DELETE</button>
    <pre id="deleteOutput"></pre>
</section>

<script>
    // Attention : vous devez exposer window.API_BASE_URL = "/api" depuis init.js
    async function apiFetch(path, opts = {}) {
        const url = (window.API_BASE_URL || "") + path;
        const res = await fetch(url, opts);
        if (!opts.method || opts.method.toUpperCase() === 'GET') {
            return res.json();
        }
        return res;
    }

    // GET ALL
    function fetchGetAll() {
        apiFetch('/promotions')
            .then(data => document.getElementById('getAllOutput').textContent = JSON.stringify(data, null, 2))
            .catch(err => console.error(err));
    }
    // GET BY ID
    function fetchGetById() {
        const id = document.getElementById('getId').value;
        apiFetch(`/promotions/${id}`)
            .then(data => document.getElementById('getByIdOutput').textContent = JSON.stringify(data, null, 2))
            .catch(err => console.error(err));
    }
    // POST
    async function fetchPost() {
        const desc = document.getElementById('postDesc').value;
        const form = new FormData();
        form.append('data', new Blob([ JSON.stringify({
            administrateurId: 1,
            validFrom: '2025-07-01T00:00:00Z',
            validTo:   '2025-07-07T23:59:59Z',
            description: desc
        })], { type: 'application/json' }));
        const file = document.getElementById('fileInput').files[0];
        if (file) form.append('file', file);

        try {
            const resp = await fetch((window.API_BASE_URL || "") + '/promotions', {
                method: 'POST',
                body: form,
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                }
            });
            const json = await resp.json();
            document.getElementById('postOutput').textContent = JSON.stringify(json, null, 2);
        } catch(e) {
            console.error(e);
        }
    }
    // PUT
    async function fetchPut() {
        const id = document.getElementById('putId').value;
        const desc = document.getElementById('putDesc').value;
        if (!id) {
            return document.getElementById('putOutput').textContent = 'Il faut un ID.';
        }
        const form = new FormData();
        form.append('data', new Blob([ JSON.stringify({
            administrateurId: 1,
            validFrom: '2025-07-02T00:00:00Z',
            validTo:   '2025-07-08T23:59:59Z',
            description: desc
        })], { type: 'application/json' }));
        const file = document.getElementById('putFile').files[0];
        if (file) form.append('file', file);

        try {
            const resp = await fetch((window.API_BASE_URL || "") + `/promotions/${id}`, {
                method: 'PUT',
                body: form,
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
                }
            });
            const out = await resp.json();
            document.getElementById('putOutput').textContent = JSON.stringify(out, null, 2);
        } catch(e) {
            console.error(e);
        }
    }
    // DELETE
    async function fetchDelete() {
        const id = document.getElementById('deleteId').value;
        if (!id) return document.getElementById('deleteOutput').textContent = 'Il faut un ID.';
        const resp = await fetch((window.API_BASE_URL || "") + `/promotions/${id}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('jwtToken')
            }
        });
        document.getElementById('deleteOutput').textContent = resp.status === 204 ? 'Supprimé ✔' : `Erreur HTTP ${resp.status}`;
    }
</script>
</body>
</html>
